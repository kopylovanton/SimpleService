Конфигурирование нового сервиса
===============================
В данном разделе представлена конфигурации базового сервиса 
на основе select * from dual запроса.

Предусловие: 
- выполнены настройки сервера из описание /install/readme.md
- заведен пользователь базы данных Oracle для сервиса (в текущей конфигурации предполагается имя пользователя`flask`) 


## Конфигурирование сервиса (пользователь flask)
```shell script
$ cd ~/api/
$ tar -xf simpleservice_linux.tar.gz
$ mv simpleservice <new_service_name>
```
### Редактирование /config/config_db.yaml

```shell script
nano config/configdb.yaml
```
параметры подключения к базе данных. Необходимо указать актуальные параметры

Параметр|Назначенение
--------|------------
CURRENT_SCHEMA|имя пользователя владельца схемы по умолчанию
DB_CONN_POOL|пул конектов к базе данных (влияет на пропускную способность/производительность) сервиса
DB_CONN_STRING|строка подключения
DB_ENCODING|кодировка базы данных
DB_EXECUTE_TIMEOUT|время в милисикундах ожидание ответа от базы данных на запрос сервиса
DB_USER_NAME| имя пользователя
DB_USER_PASSWORD| пароль, после первого запуска пароль автоматически шифруется и перезаписывается в файл в шифрованном виде


### Выпонить setup.sh указав в качестве параметра имя нового сервиса

**имя нового сервиса должно совпадать с каталогом в котором располагаются файлы**

```shell script
$ cd ~/api/<new_service_name>
$ sudo ./setup.sh <new_service_name>
```

Проверка
--------
```shell script
sudo systemctl status api-<new_service_name>
```
должна появится информация о запуске сервсиса. pid процессов не должны меняться если команду статуса запустить несколько раз подряд

Настройка конфигурации Nginx при настройке первого сервиса на этом сервере
----------------------------
Изменить конфигурацию 
```shell script
sudo nano /etc/nginx/sites-available/api-config
```
укзать корректное имя сервера и/или ip адрес
```shell script
# set the correct host(s) for your server
server_name api-flask 192.168.1.38;
``` 

Протестируйте конфигурацию Nginx на ошибки синтаксиса:
```shell script
sudo nginx -t
```

Первый запуск
-------------

Если ошибок не будет найдено, перезапустите Nginx с помощью следующей команды:
```shell script
sudo systemctl restart nginx
```




в браузере наберите 
```
<host>/<new_service_name>/swagger
```

**Должна отобразиться документация по шаблонному сервису на основе запроса `select from dual`**

**проверьте логи на наличие ошибок**

```shell script
cat ./log/<new_service_name>.log
sudo cat /var/log/nginx/error.log
```

#### если конфигурация не отображается необходимо проверить логи на наличие ошибок

```shell script
$ cat ./log/<new_service_name>.log
$ sudo cat /var/log/nginx/access.log
$ sudo cat /var/log/nginx/error.log
$ sudo systemctl status api-<new_service_name> -l
```


Далее необходимо сконфигурировать SQL запрос нового сервиса

## Сконфигурируйте или скопируйте готовую конфигурацию нового сервиса /config/config_service.yaml

- детали по параметрам конфигураиционных файлов смотри в [/template/config/readme.md]

Примеры команды управления сервисом
----------------------------------
### Запуск (выполнено при запуске ./setup.sh)
```shell script
sudo systemctl start api-<new_service_name> 
```
### Статус
```shell script
sudo systemctl status api-<new_service_name>
```
### Остановка
```shell script
sudo systemctl stop api-<new_service_name>
```
### Разрешить старт при перезагрузке сервера (выполнено при запуске ./setup.sh)
```shell script
sudo systemctl enable api-<new_service_name>
```


# Описание процесса разворачивания
При разворачивании очередного сервиса на сервере необходимо:

- придумать уникальной имя сервиса, например getAuthList и создать каталог ```~/api/<service name>/```
- скопировать базовую конфигурацию из архива ```simpleservice_linux.tar.gz```на Linux сервер под пользователем flask по пути ```~/api/<service name>/```
- провести настройку или скопировать готовую конфигурацию сервиса
- запустить установочный скрипт ```./setup.sh``` для конфигурирования нового системного сокета и сервиса для службы serviced и настройки взаимодействия с nginx  
- предоставить пользователю flask базы данных права на ``select/execute``` для объектов из Select выражения

Перечень файлов
---------------
- /config/config_service.yaml  - конфигурации сервиса
- /config/config_db.yaml - параметры доступа к базе данных. Пароль указаывается в открытом виде и автоматически шифруется и заменяется в файле при первом запуске
- /config/config_log.py - конфигурирование системы логирования
- /log/ - сюда будут сохранены логи после старта сервиса 
- /src/ - исполняемый код 
- /lib/ - зависимости python необходимые для работы
- /systemd/ - шаблоны конфигураций сервиса и сокета
- /nginx/ - конфигурация Nginx
- ./run.sh - скрипт запуска (его использует сервис systemd для запуска приложения) 
- start_server.py - базовый wsgi исполняемый файл
- ./setup.sh - скрипт конфигурирования нового сервиса